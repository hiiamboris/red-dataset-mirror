
#134: Program arguments and environment
================================================================================
Issue is closed, was reported by Kaj-de-Vos and has 6 comment(s).
[status.built] [status.tested] [type.bug]
<https://github.com/red/red/issues/134>

There should be a way to get the arguments for a program, and to let the C library get environment variables, the program environment needs to be passed to the C library. This needs to be generated by Red in machine code, because these values are passed by the kernel.

Consider the native stub for Syllable and Linux C library startup code:

```
Red/System []

#import [LIBC-file cdecl [
    libc-start: "__libc_start_main" [
        main [function! [
            argc [integer!]
            argv [byte-ptr!]
            env [byte-ptr!]
            return: [integer!]
        ]]
;       For Linux:
;       argc [integer!]
        argv [byte-ptr!]
;       For Syllable:
        env [byte-ptr!]
        init [function! []]
        fini [function! []]
;       For Linux:
;       rtld-fini [function! []]
        stack-end [byte-ptr!]
    ]
]]

main: func [
    [callback]
    argc [integer!]
    argv [byte-ptr!]
    env [byte-ptr!]
    return: [integer!]
][
    0
]

; For Syllable:
libc-start :main argv env null null null
; For Linux:
;libc-start :main argc argv null null null null

print "Here be dragons"
```

For both, argv is missing. For Syllable, the env pointer to the environment is missing. For Linux, argc is missing.

Syllable's stack layout from the kernel to a new process is here:

http://syllable.cvs.sourceforge.net/viewvc/syllable/syllable/system/apps/utils/Builder/packages/Syllable/glibc-2.7/patches/syllable/sysdeps/i386/elf/start.S?view=markup

```
dummy
argv pointer
env pointer
```

Linux's startup process is described here:

http://gd.tuwien.ac.at/pub/linuxgazette/issue84/hawk.html

```
argc
argv
env
```

The author is confused how argv and env are passed. He seems to think they're pointers to the heap, like on Syllable, but the assembly code shows that they're on the stack.



Comments:
--------------------------------------------------------------------------------

On 2011-07-20T21:20:23Z, dockimbel, commented:
<https://github.com/red/red/issues/134#issuecomment-1619096>

    Fixed by commit [0f130453](https://github.com/dockimbel/Red/commit/0f13045356d412a0f9e2ddb6a58339cae2e657a4)
    
    Syllable support does not work, I cannot see why...

--------------------------------------------------------------------------------

On 2011-07-20T22:34:44Z, dockimbel, commented:
<https://github.com/red/red/issues/134#issuecomment-1619683>

    Found the issue with Syllable. Will post a fix asap.

--------------------------------------------------------------------------------

On 2011-07-21T10:17:07Z, dockimbel, commented:
<https://github.com/red/red/issues/134#issuecomment-1622630>

    Fixed by commit [546f0db0](https://github.com/dockimbel/Red/commit/546f0db04d8b63da3e13653299d1023fe9ee271d)

